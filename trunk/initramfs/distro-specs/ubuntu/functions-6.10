# Copyright (c) 2003 - 2006 - RZ Uni Freiburg
# Copyright (c) 2006, 2007 - OpenSLX GmbH
#
# This program/file is free software distributed under the GPL version 2.
# See http://openslx.org/COPYING
#
# If you have any feedback please consult http://openslx.org/feedback and
# send your feedback to feedback@openslx.org
#
# General information about OpenSLX can be found under http://openslx.org
#
# Configuration script for Ubuntu 6.10 to configure OpenSLX linux stateless
# clients (merged in stage2 with ubuntu/functions-default - and loaded within
# initial ramfs - stage3) It may overwrite settings from the default config
# file (/etc/functions)

# distro specific stuff to initialize
preinit () {
  echo "Creating dhcp user"
  echo "dhcp:x:101:">>/etc/group
  echo "dhcp:x:101:101::/nonexistent:/bin/false" >>/etc/passwd
  # mount/unionfs can not handle the nfsro parameter in Ubuntu 6.06 
  NFSRO=""
}

# distro specific function called from servconfig script
config_distro () {
# add the halt link to the 0 and 6 runlevel directories
  ln -sf ../init.d/halt /mnt/etc/rc0.d/S90halt
  ln -sf ../init.d/reboot /mnt/etc/rc6.d/S90reboot
  sed -i '/halt.*-i/s/ -i / /' /mnt/etc/init.d/halt  
  # set default runlevel
  # how that is done for upstart??
}

# x11 stuff
descsession () {
if [ "x$desktop_session" != "x" ] ; then
  windowmanagers="$desktop_session"
  # write script for desktop-session chooser
  if [ "x$vmware" != "xno" ] ; then
    debug=""
    [ ${DEBUGLEVEL} -gt 0 ] && debug="--debug 1"
    echo -e "#!/bin/sh\n#\n# file generated by\n#\t$0:\n#\t$date\n
OSTYPE=\`echo \$0 | sed -e \"s,-, ,\" -e \"s,.*/,,\" | awk '{print \$1}'\`
SPECTYPE=\`echo \$0 | sed -e \"s,-, ,\" -e \"s,.*/,,\" | awk '{print \$2}'\`\n
OPTS=\"-o \$OSTYPE \${SPECTYPE:+\"-s \$SPECTYPE\"}\"\n
xterm -bg black -fg white -geometry 170x30+0-0 +sb \
-e \"runvmware \$OPTS $debug\"\n" > /mnt/var/X11R6/bin/desktop-session
    chmod a+x /mnt/var/X11R6/bin/desktop-session
    addpath="true";
  fi
else
  windowmanagers="kde,gnome,icewm,failsafe"
fi
# check if /usr/X11R6/bin is writeable, else use /var/X11R6/bin
if [ -w /mnt/usr/X11R6/bin/WM-Session ] ; then
  sesspath="/usr/X11R6/bin"
else
  sesspath="/var/X11R6/bin"
  addpath="true"
fi

# create links to desktop-session chooser
# fixme: wmlist is SuSE stuff !?!?
[ -f /mnt/usr/bin/X11/wmlist ] && wmlist=`cat /mnt/usr/bin/X11/wmlist`

for i in `echo $windowmanagers|sed -e "s/,/ /g"` ; do
  # beware!! quickhack for VMware sessions
  strinstr "$i" "$wmlist" || \
    test -x /mnt/usr/X11R6/bin/$i || \
    echo -e "[Desktop Entry]\nX-SuSE-translate=true\nEncoding=UTF-8\n\
Type=XSession\nExec=$i\nTryExec=$sesspath/$i\n\
Name=$i\n" > /mnt/etc/X11/sessions/$i.desktop
  # does not work correctly (add /var/X11R6/bin to path!!)
  test -x /mnt/usr/X11R6/bin/$i || \
    ln -fs /var/X11R6/bin/desktop-session /mnt/$sesspath/$i
done

# add special path /var/X11R6/bin to the PATH variable
# fixme!! add path directly to /etc/profile!?
#[ "x$addpath" != "x" ] && \
#  echo -e "# added path component by $0: $date\n\
#PATH=\"\$PATH:/var/X11R6/bin\"" >>/mnt/etc/profile
}

# set up keytable (function run in hwautocfg)
# fixme: is anything needed here - otherwise remove (and check that a 
# dummy function is present)
keytable () {
# fixme -- use keytable setup script here
:
}

# consolefont and language
consolefont () {
[ "$LANG" == "de_DE@euro" ] && LANG=de_DE.UTF8
sed -e "s,LANGUAGE=.*,LANGUAGE=${LANG},;s,LANG=.*,LANG=${LANG}," \
    -i /mnt/etc/environment
rllinker "console-screen.sh" 31 3
}

# configure kdm as display manager
config_kdm () {
# first define directories for kdm
local kdmrcdir=/etc/kde3/kdm
local xdmdir=/etc/kde3/kdm
testmkd /mnt/${kdmrcdir}

rllinker "kdm" 3 1
if [ "x$start_xdmcp" = "xkdm" ]; then 
  echo /usr/bin/kdm > /mnt/etc/X11/default-display-manager
fi
# write configuration file; use general config in /etc/functions
config_kdm_template
}

