# Copyright (c) 2003 - 2006 - RZ Uni Freiburg
# Copyright (c) 2006, 2007 - OpenSLX GmbH
#
# This program/file is free software distributed under the GPL version 2.
# See http://openslx.org/COPYING
#
# If you have any feedback please consult http://openslx.org/feedback and
# send your feedback to feedback@openslx.org
#
# General information about OpenSLX can be found under http://openslx.org
#
# Configuration script for general Ubuntu to configure OpenSLX linux
# stateless clients (executed within initial ramdisk after genconfig) 

# empty functions are defined at the beginning of /etc/functions

# distro specific stuff to initialize
preinit () {
  [ $DEBUGLEVEL -ge 1 ] && echo "Creating dhcp user"
  echo "dhcp:x:101:">>/etc/group
  echo "dhcp:x:101:101::/nonexistent:/bin/false" >>/etc/passwd
  # load unix module to provide sockets (is compiled into kernel on
  # the live CDs!?)
  modprobe ${MODPRV} unix 2>/dev/null || error "$df_errumod" nonfatal
  modprobe ${MODPRV} vesafb 2>/dev/null || error "$df_errumod" nonfatal
  modprobe ${MODPRV} fbcon 2>/dev/null || error "$df_errumod" nonfatal
}

# overwrite settings set by hwautocfg, pathes will change for newer
# Xorg version 7.X
displayvars (){
Files=' \t 	  FontPath\t\t       "/usr/share/X11/fonts/misc"\n
\t        FontPath\t\t    "/usr/share/X11/fonts/100dpi/:unscaled"\n
\t        FontPath\t\t    "/usr/share/X11/fonts/75dpi/:unscaled"\n
\t        FontPath\t\t    "/usr/share/X11/fonts/Type1"\n
\t        FontPath\t\t    "/usr/share/X11/fonts/100dpi"\n
\t        FontPath\t\t    "/usr/share/X11/fonts/75dpi"\n
'
Module=' \t        Load\t	    "i2c"\n
\t        Load\t	    "bitmap"\n
\t        Load\t	    "ddc"\n
\t        Load\t	    "dri"\n
\t        Load\t	    "extmod"\n
\t        Load\t	    "freetype"\n
\t        Load\t	    "glx"\n
\t        Load\t	    "int10"\n
\t        Load\t	    "type1"\n
\t        Load\t	    "vbe"\n'
synapticsdrv=""
}
# distro specific function called from servconfig script
config_distro () {
# add the halt link to the 0 and 6 runlevel directories
  ln -sf ../init.d/halt /mnt/etc/rc0.d/S90halt
  ln -sf ../init.d/reboot /mnt/etc/rc6.d/S90reboot
  # set default runlevel
  sed -e "s/.*initdefault/id:${D_INITDEFAULT}:initdefault/" -i /mnt/etc/inittab
}

# linking runlevel scripts
rllinker () {
local script="$1"
if [ $2 -lt 10 ] ; then
  local start="0$2"; else local start="$2"
fi
if [ $3 -lt 10 ] ; then
  local stop="0$3"; else local stop="$3"
fi
# empty runlevel links - decision on running certain services is
# passed via configuration
for i in rc2.d/K$stop$script rc3.d/K$stop$script \
         rc2.d/S$start$script rc3.d/S$start$script ; do
  if ! [ -f /mnt/etc/init.d/$script ]; then
    echo "Target `pwd`../$script does not exist. Skipping links"
    break
  else 
    ln -sf ../init.d/$script /mnt/etc/$i
    [ "$DEBUGLEVEL" == 5 ] && echo "Linked $script"
  fi
done
}

# group of functions for the normal runlevels - first parameter is start
# second stop
# function for ntp configuration
config_ntp () {
if [ -f /mnt/etc/init.d/ntp -a "x$start_ntp" != "xno" ] ; then
  echo -e "ntp:x:74:65534:NTP daemon:/var/lib/ntp:/bin/false" \
    >>/mnt/etc/passwd
  testmkd /mnt/var/lib/ntp/var/run/ntp
  rllinker "ntp" 7 14
fi
}

# function for atd
config_atd () {
if [ "x$start_atd" = "xyes" ]; then
  # testmkd /mnt/var/spool/atjobs
  # testmkd /mnt/var/spool/atspool
  # chown 1:1 /mnt/var/spool/atjobs /mnt/var/spool/atspool
  rllinker "atd" 14 4
fi
}

# function for configuration of cron services
config_cron () {
if [ "x$start_cron" = "xyes" ] ; then
  if [ -f /mnt/etc/init.d/cron ] ; then
    rllinker "cron" 18 2
    # fixme! check for proper permissions!
    testmkd /mnt/var/spool/crontabs
    echo -e "# /etc/crontab - file generated by $0:\n\
#\t$date\nSHELL=/bin/sh\nPATH=/usr/bin:/usr/sbin:/sbin:/bin:/usr/lib/news/bin\
\nMAILTO=\n-*/15 * * * *\troot\ttest -x /usr/lib/cron/run-crons && \
/usr/lib/cron/run-crons >/dev/null 2>&1\n" >/mnt/etc/crontab
  else
    error "$df_errcron" nonfatal
  fi 
fi
}

# syslog service
config_syslog () {
if [ "x$start_syslog" != "xno" ] ; then
# fixme, welcher Syslog wird verwendet?
#if syslog
  testmkd /mnt/var/log/news
  echo -e "# /etc/syslog.conf - file generated by $0" >/mnt/etc/syslogd.conf
#  test -n "$log_servers" && \
#  for logserver in $log_servers; do
#       echo -e "*.*;*.*;*.*;*kern.!*\t@$logserver" >>/mnt/etc/syslog.conf
#  done
#else syslog-ng
#  if [ -f /mnt/etc/${D_INITDIR}/syslog ] ; then
#    # logoutput depending on $start_syslog definitions
#    sysngwriter /mnt/etc/syslog-ng/syslog-ng.conf
  rllinker "sysklogd" 2 18
#else keiner installiert
#  error "$df_errsysl" nonfatal
fi
}

# secure shell service
config_sshd () {
if [ "x$start_sshd" = "xyes" ] ; then
  if [ -f /mnt/etc/init.d/ssh ] ; then
    #testmkd /mnt/var/run/sshd
    rllinker "ssh" 12 10
  else
    error "$df_errsshd" nonfatal
  fi
fi
}

# snmp agent for remote monitoring
config_snmp () {
if [ "x$start_snmp" = "xyes" ] ; then
  if [ -f /mnt/etc/init.d/snmpd ] ; then
    rllinker "snmpd" 24 2
    testmkd /mnt/var/lib/net-snmp >/dev/null 2>&1
  fi
    # fixme!!
    # write service monitor depending on services started
  fi
}

# set up keytable (function run in hwautocfg)
keytable () {
# fixme -- use keytable setup script here
:
}

# consolefont
consolefont () {
echo -e "\tsetfont ${CONSOLE_FONT} >${LOGFILE} 2>&1" \
  >>/mnt/etc/${D_INITDIR}/boot.slx
}


# acpi and powersave
config_acpi () {
  rllinker "acpid" 10 19
  #Commented out since battery checking is only useful for Notebooks
  #rllinker "acpi-support" 99 2

  # nur hier weil udev_hotplug zu früh aufgerufen wird. -> Hm, warum zu
  # früh an der anderen Stelle - was fehlt?? udev_hotplug gibts im Stage3
  # nicht mehr!!
  rllinker "udev" 11 25
}

# configure gdm as display manager
config_gdm () {
ln -sf ../${D_INITDIR}/gdm /mnt/etc/rc3.d/K20gdm
if [ "x$start_xdmcp" = "xgdm" ]; then 
  #  configure fallback if no gdm binary present
  if ! binfinder gdm; then
    config_kdm
    # error "" nonfatal
  else
    echo $(binfinder gdm) > /mnt/etc/X11/default-display-manager
  fi
fi
ln -sf ../${D_INITDIR}/gdm /mnt/etc/rc3.d/S01gdm
# append gdm user; check for presence first
if ! grep "gdm:" /mnt/etc/passwd >/dev/null 2>&1; then
  echo "gdm:x:113:" >>/mnt/etc/group
  echo "gdm:x:106:113:Gnome Display Manager:/var/lib/gdm:/bin/false" \
    >>/mnt/etc/passwd
fi
testmkd /mnt/var/lib/gdm/.fontconfig
echo -e "\tchown gdm:gdm /var/lib/gdm/.fontconfig\n\tchown root:gdm \
/var/lib/gdm\n" >>/mnt/etc/${D_INITDIR}/boot.slx
# fixme: check if a gdm.conf was provided via ConfTGZ
# [ -f /rootfs/etc/gdm/gdm.conf ??? ] || \
echo -e "# /etc/gdm/gdm.conf - file generated by $0\n\

[daemon]
AutomaticLoginEnable=false
AutomaticLogin=
TimedLoginEnable=false
TimedLogin=
TimedLoginDelay=30
Greeter=/usr/lib/gdm/gdmgreeter
DefaultPath=/usr/local/bin:/usr/local/sbin:/sbin:/usr/sbin:/bin:/usr/bin:/usr/bin/X11:/usr/games
RootPath=/usr/local/bin:/usr/local/sbin:/sbin:/usr/sbin:/bin:/usr/bin:/usr/bin/X11:/usr/games
User=gdm
Group=gdm
LogDir=/var/log/gdm
PidFile=/var/run/gdm.pid
PostLoginScriptDir=/etc/gdm/PostLogin/
PreSessionScriptDir=/etc/gdm/PreSession/
PostSessionScriptDir=/etc/gdm/PostSession/
DisplayInitDir=/etc/gdm/Init
XKeepsCrashing=/etc/gdm/XKeepsCrashing
RebootCommand=/sbin/shutdown -r now \"Rebooted from gdm menu.\"
HaltCommand=/sbin/shutdown -h now \"Halted from gdm menu.\"
SuspendCommand=/usr/sbin/pmi action sleep
HibernateCommand=/usr/sbin/pmi action hibernate
ServAuthDir=/var/lib/gdm
BaseXsession=/etc/gdm/Xsession
SessionDesktopDir=/etc/X11/sessions/:/etc/dm/Sessions/:/usr/share/gdm/BuiltInSessions/:/usr/share/xsessions/
DefaultSession=default.desktop
UserAuthDir=
UserAuthFBDir=/tmp
UserAuthFile=.Xauthority
StandardXServer=${D_XORGBIN}
Xnest=/usr/X11R6/bin/Xnest -br -audit 0 -name Xnest
FirstVT=7
VTAllocation=true
SoundProgram=/usr/lib/gdmplay
[security]
AllowRoot=false
AllowRemoteRoot=false
AllowRemoteAutoLogin=false
RelaxPermissions=0
CheckDirOwner=true
DisallowTCP=true
[xdmcp]
Enable=false
[gui]
GtkTheme=Human
AllowGtkThemeChange=true
GtkThemesToAllow=Human,HighContrast,HighContrastInverse,LowContrast
[greeter]
ConfigAvailable=false
Browser=true
MinimalUID=1000
Exclude=bin,daemon,adm,lp,sync,shutdown,halt,mail,news,uucp,operator,nobody,gdm,postgres,pvm,rpm
IncludeAll=true
LocaleFile=/etc/gdm/locale.conf
SystemMenu=true
SecureSystemMenu=false
DefaultWelcome=true
DefaultRemoteWelcome=true
BackgroundColor=#523921
UseCirclesInEntry=true
GraphicalTheme=Human
GraphicalThemeDir=/usr/share/gdm/themes/
GraphicalThemeRand=false
SoundOnLogin=true
SoundOnLoginFile=/usr/share/sounds/question.wav
[chooser]
HostImageDir=/usr/share/hosts/
Hosts=
Broadcast=true
Multicast=false
[debug]
Enable=false
[servers]
0=Standard
[server-Standard]
name=Standard server
command=/usr/X11R6/bin/X -br -audit 0 
flexible=true
[server-Terminal]
name=Terminal server
command=/usr/X11R6/bin/X -br -audit 0 -terminate
flexible=false
handled=false
[server-Chooser]
name=Chooser server
command=/usr/X11R6/bin/X -br -audit 0
flexible=false
chooser=true

[debug]
Enable=$debug" >/mnt/etc/gdm/gdm.conf
if [ "x$start_x" = "xindirect" ] ; then
  # when X server consumes to much mem set X -terminate
  echo -e "\n[servers]\n0=Terminal -audit 0 -indirect \
$host_name\n\n\
[server-Terminal]\nname=Terminal server\ncommand=/usr/X11R6/bin/X \
-audit 0\n\
flexible=true\nhandled=true\nchooser=true" >>/mnt/etc/gdm/gdm.conf
else
  echo -e "\n[servers]\n0=Standard\n\n\
[server-Standard]\nname=Standard server\ncommand=/usr/X11R6/bin/X\n\
flexible=true\nhandled=true" >>/mnt/etc/gdm/gdm.conf
fi
}

# configure kdm as display manager
config_kdm () {
# first define directories for kdm
kdmrcdir=/etc/kde3/kdm
xdmdir=/etc/kde3/kdm
testmkd /mnt/${kdmrcdir}
rllinker "kdm" 25 1
if [ "x$start_xdmcp" = "xkdm" ]; then 
  # configure fallback if no kdm binary is present
  if ! binfinder kdm; then
    config_gdm
    # error "kdm configured but bin not found" nonfatal
  else
    echo $(binfinder kdm) >/mnt/etc/X11/default-display-manager
  fi
fi
# write configuration file
# use general config in /etc/functions
config_kdm_template
}

# configure hal, dbus, resmgr and services like that
config_dreshal () {
if [ "x$start_dreshal" = "xyes" ]; then
  testmkd /mnt/var/lib/dbus
  rllinker "dbus" 17 20 
fi
}

# initialize boot.slx - skript to be executed during early system startup
# (before most of the normal boot init scripts)
# this script should operate like a normal runlevel script (fixme!!)
d_mkrlscript () {
local switch="$1"
local name="$2"
local info="$3"
case "$switch" in
  init)
    echo -e "#!/bin/sh\n# skeleton of /etc/${D_INITDIR}/$name written \
from $0\n# after you applied changes to the creation scripts you have to \
rerun\n# the mkdxsinitrd script to get them applied\n\n\
. /lib/lsb/init-functions\n" >/mnt/etc/${D_INITDIR}/$name
    echo -e "\n\ncase \"\$1\" in\n    start)\n\tlog_begin_msg \"$info\"" \
      >>/mnt/etc/${D_INITDIR}/$name
    chmod u+x /mnt/etc/${D_INITDIR}/$name
  ;;
  close)
    echo -e "\tlog_end_msg 0\n\t;;\n    stop)\n\t;;\nesac\nexit 0" \
      >>/mnt/etc/${D_INITDIR}/$name
  ;;
esac
}

# prepare virtual machine environment (vmware, vmplayer)
config_vmware () {
if [ -f /mnt/etc/init.d/vmware ] ; then
rllinker "vmware" 20 2
# during vmware sessions linux should not handle usb events/devices
testmkd /mnt/var/X11R6/bin
# add special path /var/X11R6/bin to the PATH variable
# fixme!! add path directly to /etc/profile!?
echo -e "# added path component by $0: $date\n\
PATH=\"\$PATH:/var/X11R6/bin\"" >>/mnt/etc/profile
echo '#!/bin/sh'>> /mnt/etc/udev/rules.d/01-udev-vm.rules
fi
}

# configure automounter
config_automount () {
if [ -f /mnt/etc/init.d/autofs ] ; then
  testmkd /var/lock/subsys
  echo -e "# /etc/auto.master - file generated by $0:\n\
/misc\t/etc/auto.misc" >/mnt/etc/auto.master
  echo -e "# /etc/auto.misc - file generated by $0:\n" \
    > /mnt/etc/auto.misc
  if [ -n "${automnt_src}" ] ; then
    # local directory and home directory server from machine-setup
    [ -z "${automnt_dir}" ] && automnt_dir="/home"
    strinstr "/" "${automnt_dir}" && error "$df_erratpld" nonfatal
    automnt_dir=${automnt_dir#/}
    echo -e "/home\t/etc/auto.${automnt_dir}\n" >> /mnt/etc/auto.master
    echo -e "# /etc/auto.${automnt_dir} created by $0:\n" \
      > /mnt/etc/auto.${automnt_dir}
    echo -e "*\t-rsize=32768,wsize=32768,tcp,rw\t${automnt_src}/&" \
      >> /mnt/etc/auto.${automnt_dir}
  fi
  sed -e "1i# /etc/${D_SYSCONFDIR}/autofs - file modified by\n#\t$0:\n#" \
      -e "s,AUTOFS_OPTIONS.*,AUTOFS_OPTIONS=\"--timeout 3\"," \
      -i /mnt/etc/${D_SYSCONFDIR}/autofs
  config_portmap
  rllinker "autofs" 18 4
fi
}

# start portmapper (needed at least for nfs and nis services)
config_portmap () {
  rllinker "portmap" 2 20
}

# start NIS (fixmee - does the service is really named ypbind??)
config_nis () {
  rllinker "ypbind" 6 16
}
