# Copyright (c) 2003 - 2006 - RZ Uni Freiburg
# Copyright (c) 2006, 2007 - OpenSLX GmbH
#
# This program/file is free software distributed under the GPL version 2.
# See http://openslx.org/COPYING
#
# If you have any feedback please consult http://openslx.org/feedback and
# send your feedback to feedback@openslx.org
#
# General information about OpenSLX can be found under http://openslx.org
#
# Configuration script for Ubuntu 7.04 to configure OpenSLX linux stateless
# clients (merged in stage2 with ubuntu/functions-default - and loaded within
# initial ramfs - stage3) It may overwrite settings from the default config
# file (/etc/functions)


# configure gdm as display manager
config_gdm () {
ln -sf ../${D_INITDIR}/gdm /mnt/etc/rc3.d/K20gdm
if [ "x$start_xdmcp" = "xgdm" ]; then 
  echo /usr/sbin/gdm > /mnt/etc/X11/default-display-manager
fi
if [ "x$late_dm" = "xyes" ] ; then
  ln -sf ../${D_INITDIR}/gdm /mnt/etc/rc3.d/S01gdm
else
  # gdm can not be started before mounting of kernelfs'
  ln -sf ../${D_INITDIR}/gdm /mnt/etc/rcS.d/S91gdm
fi
# append gdm user
echo "gdm:x:113:">>/etc/group
echo "gdm:x:106:113:Gnome Display Manager" >> /etc/shadow

# fixme: check if a gdm.conf was provided via ConfTGZ
# [ -f /rootfs/etc/gdm/gdm.conf ??? ] || \
echo -e "# /etc/gdm/gdm.conf - file generated by $0\n\

[daemon]
AutomaticLoginEnable=false
AutomaticLogin=
TimedLoginEnable=false
TimedLogin=
TimedLoginDelay=30
Greeter=/usr/lib/gdm/gdmgreeter
DefaultPath=/usr/local/bin:/usr/local/sbin:/sbin:/usr/sbin:/bin:/usr/bin:/usr/bin/X11:/usr/games
RootPath=/usr/local/bin:/usr/local/sbin:/sbin:/usr/sbin:/bin:/usr/bin:/usr/bin/X11:/usr/games
User=gdm
Group=gdm
LogDir=/var/log/gdm
PidFile=/var/run/gdm.pid
PostLoginScriptDir=/etc/gdm/PostLogin/
PreSessionScriptDir=/etc/gdm/PreSession/
PostSessionScriptDir=/etc/gdm/PostSession/
DisplayInitDir=/etc/gdm/Init
XKeepsCrashing=/etc/gdm/XKeepsCrashing
RebootCommand=/sbin/shutdown -r now \"Rebooted from gdm menu.\"
HaltCommand=/sbin/shutdown -h now \"Halted from gdm menu.\"
SuspendCommand=/usr/sbin/pmi action sleep
HibernateCommand=/usr/sbin/pmi action hibernate
ServAuthDir=/var/lib/gdm
BaseXsession=/etc/gdm/Xsession
SessionDesktopDir=/etc/X11/sessions/:/etc/dm/Sessions/:/usr/share/gdm/BuiltInSessions/:/usr/share/xsessions/
DefaultSession=default.desktop
UserAuthDir=
UserAuthFBDir=/tmp
UserAuthFile=.Xauthority
StandardXServer=${D_XORGBIN}
Xnest=/usr/X11R6/bin/Xnest -br -audit 0 -name Xnest
FirstVT=7
VTAllocation=true
SoundProgram=/usr/lib/gdmplay
[security]
AllowRoot=false
AllowRemoteRoot=false
AllowRemoteAutoLogin=false
RelaxPermissions=0
CheckDirOwner=true
DisallowTCP=true
[xdmcp]
Enable=false
[gui]
GtkTheme=Human
AllowGtkThemeChange=true
GtkThemesToAllow=Human,HighContrast,HighContrastInverse,LowContrast
[greeter]
ConfigAvailable=false
Browser=true
MinimalUID=1000
Exclude=bin,daemon,adm,lp,sync,shutdown,halt,mail,news,uucp,operator,nobody,gdm,postgres,pvm,rpm
IncludeAll=true
LocaleFile=/etc/gdm/locale.conf
SystemMenu=true
SecureSystemMenu=false
DefaultWelcome=true
DefaultRemoteWelcome=true
BackgroundColor=#523921
UseCirclesInEntry=true
GraphicalTheme=Human
GraphicalThemeDir=/usr/share/gdm/themes/
GraphicalThemeRand=false
SoundOnLogin=true
SoundOnLoginFile=/usr/share/sounds/question.wav
[chooser]
HostImageDir=/usr/share/hosts/
Hosts=
Broadcast=true
Multicast=false
[debug]
Enable=false
[servers]
0=Standard
[server-Standard]
name=Standard server
command=/usr/X11R6/bin/X -br -audit 0 
flexible=true
[server-Terminal]
name=Terminal server
command=/usr/X11R6/bin/X -br -audit 0 -terminate
flexible=false
handled=false
[server-Chooser]
name=Chooser server
command=/usr/X11R6/bin/X -br -audit 0
flexible=false
chooser=true

[debug]
Enable=$debug" >/mnt/etc/gdm/gdm.conf
if [ "x$start_x" = "xindirect" ] ; then
  # when X server consumes to much mem set X -terminate
  echo -e "\n[servers]\n0=Terminal -audit 0 -indirect \
$host_name\n\n\
[server-Terminal]\nname=Terminal server\ncommand=/usr/X11R6/bin/X \
-audit 0\n\
flexible=true\nhandled=true\nchooser=true" >>/mnt/etc/gdm/gdm.conf
else
  echo -e "\n[servers]\n0=Standard\n\n\
[server-Standard]\nname=Standard server\ncommand=/usr/X11R6/bin/X\n\
flexible=true\nhandled=true" >>/mnt/etc/gdm/gdm.conf
fi
}
