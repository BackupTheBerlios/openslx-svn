#!/bin/sh
#
# Description:  Adaptation of a generic runlevel script file for use with
#               Diskless X Stations (v4.0) - script prepares vmware
#               environment
#
# Author(s):    Michael Janczyk <mj0@uni-freiburg.de>, 09-03-2006
#               Dirk von Suchodoletz <dirk@goe.net>, 08-03-2006
# Copyright:    (c) 2003, 2006 - RZ Universitaet Freiburg
#
# Version:      0.1a
################################################################################



### VERBOSE? ###################################################################
# set verbose mode (set -x(v))
#set -xv



### CONFIGURATION ##############################################################
# read configuration information
. /etc/machine-setup



### VARIABLES SECTION ##########################################################
# Declaration of default variables
vmdir="/var/lib/vmware"



### FUNCTIONS SECTION ##########################################################



### START SCRIPT ###############################################################

echo -n "Starting preparation of vmware environment "


# mount von zeugs
mount -t nfs -o ro,nolock,intr,nodev,soft,timeo=2,nosuid ${vmimgsrc} ${vmdir} &


# device creation - the module does not trigger udev properly
for i in 0 1 2 3 4 5 6 7 8 9; do
  [ -c /dev/vmnet${i} ] || mknod /dev/vmnet${i} c 119 ${i};
done

chmod 0700 /dev/vmnet*


# special start script for vmware with predefined image
if test -w /usr/X11R6/bin ; then
  path="/usr/X11R6/bin"
  cp ${vmdir}/import/templ/runvmware \
     /usr/X11R6/bin
else
  path="/var/X11R6/bin"
  test -d /var/X11R6/bin || mkdir -p /var/X11R6/bin
  cp ${vmdir}/import/templ/runvmware \
     /var/X11R6/bin
fi


# copy blabla
cp -a ${vmdir}/import/templ/* ${vmdir}/templ


# loop file for exchanging information between linux and vmware
mkdir -p /media/loop0
cp ${vmdir}/templ/img.fd0 /tmp
chmod a+rw /tmp/${clientip}-fd0.img
# UNIONFS test bei ram
mount -t msdos -o loop,umask=000 /tmp/${clientip}-fd0.img \
  /media/loop0


# blabla sessiondinens
echo -e "#!/bin/sh\n#\n# file generated by\n#\t${0}:\n#\t${date}\n
  os=\$(echo \$0 | sed -e \"s,-, ,\" -e \"s,.*/,,\" | awk '{print \$1}')
  spec=\$(echo \$0 | sed -e \"s,-, ,\" -e \"s,.*/,,\" | awk '{print \$2}')\n
  options=\"-o \${os} \${spec:+\"-s \${spec}\"}\"\n

  xterm -bg black -fg white -geometry 170x30+0-0 +sb \
    -e \"${path}/runvmware \${options} ${debug}\"\n" \
> ${path}/desktop-session


# copy nach blabla
for i in ${vmdir}/vmsessions/*.desktop; do
  session_name=$(cat ${vmdir}/vmsessions/${i} | grep -iw "exec" \
    | awk -F "=" '{print $2}')
  cp ${path}/desktop-session ${path}/${session_name}
done




# hier fehlt noch was ;)


